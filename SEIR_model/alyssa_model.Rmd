---
title: "SEIR Model with Vaccination"
author: "Alyssa Anastasi"
date: "`r format(Sys.time(), '%B %Y')`"
  output:
  pdf_document: default
  html_document: default
---

## Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(deSolve)
library(tidyverse)
library(MetBrewer)
library(directlabels)
library(cowplot)
library(viridis)
library(RColorBrewer)
library(ggrepel)
library(spatstat.utils)
library(paletteer)
library(bbmle)
library(mgcv)
source("alyssa_seir.R")
source("alyssa_SEIR_params.R")
source("alyssa_pertussis_seir.R")
source("alyssa_seasonality.R")
source("mortality_data.R")
```

## DataFrame Set Up Function Using ODE
```{r}
run_ode <- function(init, seir, times, parms, vacc_type, disease) {
  vaccs <- set_vacc(disease, vacc_type)
  # seasonality_fn <- set_seasonality(disease)
  full_parms <- c(parms, vaccs)
  df <- ode(y=init, func = seir, times=times, parms = full_parms) %>% 
  as.data.frame() %>% as_tibble() %>% pivot_longer(-time) %>%
  mutate(name = fct_relevel(name, names(init)),
         type = vacc_type) %>%
  mutate(group = case_when(
      grepl("^S_C1|^S_C2|^E_C1|^E_C2|^I_C1|^I_C2|^H_C1|^H_C2|^E_C2|^R_C1|^R_C2|^D_C1|^D_C2", name) ~ "Children",
      grepl("^S_CA|^E_CA|^I_CA|^H_CA|^R_CA|^D_CA", name) ~ "Childless Adults",
      grepl("^S_P|^E_P|^I_P|^H_P|^R_P|^D_P", name) ~ "Adults with Children (Parents)",
      grepl("^S_S|^E_S|^I_S|^H_S|^R_S|^D_S", name) ~ "Adults (50+)",
  )) %>%
    mutate(label = case_when(
      grepl("^S_.*1$", name) ~ "Susceptible (First)",
      grepl("^S_.*2$", name) ~ "Susceptible (Second)",
      grepl("^E_.*1$", name) ~ "Exposed (First)",
      grepl("^E_.*2$", name) ~ "Exposed (Second)",
      grepl("^I_.*1$", name) ~ "Infected (First)",
      grepl("^I_.*2$", name) ~ "Infected (Second)",
      grepl("^H_.*1$", name) ~ "Hospitalized (First)",
      grepl("^H_.*2$", name) ~ "Hospitalized (Second)",
      grepl("^R_.*1$", name) ~ "Recovered (First)",
      grepl("^R_.*2$", name) ~ "Recovered (Second)",
      grepl("^D_.*1$", name) ~ "Dead (First)",
      grepl("^D_.*2$", name) ~ "Dead (Second)"
  ))
  return(df)
}
```

## Plot Functions
```{R}
full_plot <- function(df, title) {
  df %>% drop_na(label) %>% ggplot(aes(x=time,y=value, color=label)) + 
  geom_line() + 
  facet_wrap(~group, scales = "free", ncol = 2) +
  ggtitle(title) + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        legend.key.width=unit(0.3,"cm"),
        legend.key.height =unit(0.6,"cm"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        legend.title = element_text(colour = "black", size = 10),
        legend.text = element_text(colour = "black", size = 9),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="gray95", fill="gray95"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"))
}

infection_plot <- function(df, title, min_time, max_time) {
  if (is.null(max_time)) {
    max_time = max(times) + 1
  }
  df %>% filter(time < max_time) %>% filter(time > min_time) %>%
  ggplot(aes(x=time, y=infections, color=type)) +
  geom_line() + 
  scale_color_paletteer_d("MoMAColors::Andri") +
  facet_wrap(~group, ncol = 2) +
  ggtitle(title) + 
  labs(x = "Time (Days)", y = "Infections (Count)", color = "Vaccination Coverage") + 
  theme_bw() +
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        legend.key.width=unit(0.3,"cm"),
        legend.key.height =unit(0.6,"cm"),
        plot.title = element_text(colour = "black", size = 15, face = "bold"),
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        legend.title = element_text(colour = "black", size = 9),
        legend.text = element_text(colour = "black", size = 8),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="gray95", fill="gray95", linetype=1),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"))
}

infection_plot_prop <- function(df, title, min_time, max_time) {
  if (is.null(max_time)) {
    max_time = max(times) + 1
  }
  df %>% filter(time < max_time) %>% filter(time > min_time) %>%
  ggplot(aes(x=time, y=proportion, color=type)) +
  geom_line() + 
  ylim(0, 1) + 
  scale_color_paletteer_d("MoMAColors::Andri") +
  facet_wrap(~group, ncol = 2) +
  ggtitle(title) + 
  labs(x = "Time (Days)", y = "Infections (Proportion)", color = "Vaccination Coverage") + 
  theme_bw() +
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        legend.key.width=unit(0.3,"cm"),
        legend.key.height =unit(0.6,"cm"),
        plot.title = element_text(colour = "black", size = 15, face = "bold"),
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        legend.title = element_text(colour = "black", size = 9),
        legend.text = element_text(colour = "black", size = 8),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="gray95", fill="gray95", linetype=1),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"))
}
```

## Vaccination Function
```{R}
set_vacc <- function(disease, type) {
  WVH <- 15
  k <- 1.75
  if (type == "No Vaccination"){
    vaccC <- function(t){0}
    vaccCA <- function(t){0}
    vaccP <- function(t){0}
    vaccS <- function(t){0}
  } else if (type == "Current Vaccination") {
      if (disease == "COVID-19") {
        vaccC <- vacc_weekly(0.38561776061776104, WVH, k)
        vaccCA <- vacc_weekly(0.5117845117845116, WVH, k)
        vaccP <- vacc_weekly(0.5441389290882782, WVH, k)
        vaccS <- vacc_weekly(0.7282965743782258, WVH, k)
      } else if (disease == "Flu") {
        vaccC <- vacc_weekly(0.5974963890226275, WVH, k)
        vaccCA <- vacc_weekly(0.3661491859144262, WVH, k)
        vaccP <- vacc_weekly(0.4923757993113624, WVH, k)
        vaccS <- vacc_weekly(0.6057398259233123, WVH, k)
      } else if (disease == "RSV") {
        vaccC <- vacc_weekly(0.5346153846153847, WVH, k)
        vaccCA <- vacc_weekly(0, WVH, k)
        vaccP <- vacc_weekly(0, WVH, k)
        vaccS <- vacc_weekly(0, WVH, k)
      } else if (disease == "Pertussis") {
        vaccC <- vacc_weekly(0.8594594594594596, WVH, k)
        vaccCA <- vacc_weekly(0, WVH, k)
        vaccP <- vacc_weekly(0, WVH, k)
        vaccS <- vacc_weekly(0, WVH, k)
      }
  } else if (type == "Same Vaccination") {
    if (disease == "COVID-19") {
        vaccC <- vacc_weekly(0.5441389290882782, WVH, k)
        vaccCA <- vacc_weekly(0.5441389290882782, WVH, k)
        vaccP <- vacc_weekly(0.5441389290882782, WVH, k)
        vaccS <- vacc_weekly(0.7282965743782258, WVH, k)
    } else if (disease == "Flu") {
        vaccC <- vacc_weekly(0.5974963890226275, WVH, k)
        vaccCA <- vacc_weekly(0.5974963890226275, WVH, k)
        vaccP <- vacc_weekly(0.5974963890226275, WVH, k)
        vaccS <- vacc_weekly(0.6057398259233123, WVH, k)
    } else if (disease == "RSV") {
        vaccC <- vacc_weekly(0.5346153846153847, WVH, k)
        vaccCA <- vacc_weekly(0.5346153846153847, WVH, k)
        vaccP <- vacc_weekly(0.5346153846153847, WVH, k)
        vaccS <- vacc_weekly(0.5346153846153847, WVH, k)
    } else if (disease == "Pertussis") {
        vaccC <- vacc_weekly(0.8594594594594596, WVH, k)
        vaccCA <- vacc_weekly(0.8594594594594596, WVH, k)
        vaccP <- vacc_weekly(0.8594594594594596, WVH, k)
        vaccS <- vacc_weekly(0.8594594594594596, WVH, k)
    }
  }
  return(c(vaccC = vaccC, vaccCA = vaccCA, vaccP = vaccP, vaccS = vaccS))
}
```

### COVID

## Callibrate Seasonality
```{R}
covid_parms_full = get_parms(covid_parms, "No Vaccination", "COVID-19")

cov_start = list(
  mu_janmar = 0.378, 
  mu_aprjun = 0.378, 
  mu_julsep = 0.378, 
  mu_octdec = 0.378, 
  sig_dist = 0.2)

cov_upper_limit = list(
  mu_janmar = 1.5, 
  mu_aprjun = 1.5, 
  mu_julsep = 1.5, 
  mu_octdec = 1.5, 
  sig_dist = 2
)

cov_lower_limit = list(
  mu_janmar = 0.01, 
  mu_aprjun = 0.01, 
  mu_julsep = 0.01, 
  mu_octdec = 0.01, 
  sig_dist = 0.05
)

cov_m1_A = mle2(minuslogl = loglik,
              start = cov_start,
              data = covid_mortality,
              method = "L-BFGS-B",
              #fixed = list(mu = 0.03),
              upper= cov_upper_limit,
              lower = cov_lower_limit,
              control=list(maxit=20000, trace=TRUE, parscale=abs(unlist(cov_start))))
```

```{R}
full <- summary(m1_A)
dt <- data.table::as.data.table(coef(full), .keep.rownames = "word")
```

## Run Model
```{r}
COVIDNoVac <- run_ode(init, seir, times, covid_parms, "No Vaccination", "COVID-19")
COVIDCurrVac <- run_ode(init, seir, times, covid_parms, "Current Vaccination", "COVID-19")
COVIDSameVac <- run_ode(init, seir, times, covid_parms, "Same Vaccination", "COVID-19")

# make new dataframe with infections for each group
COVIDout <- rbind(COVIDNoVac, COVIDCurrVac, COVIDSameVac) 
# filter so only infections
COVIDoutGrouped <- COVIDout %>% filter(str_starts(name, "I_")) %>%
            group_by(time, type, group) %>%
            summarise(infections = sum(value)) %>%
            mutate(proportion = infections / total_pop[group])

COVIDoutGrouped$type <- factor(COVIDoutGrouped$type, levels=c('No Vaccination', 'Current Vaccination', 'Same Vaccination'))
```
```{R}
COVIDplotInfections60ct <- infection_plot(COVIDoutGrouped, "COVID-19 Infections Count (60 days)", 0, 60)
ggsave("figures/COVIDplotInfections60ct.png", width = 10, height = 7, dpi = 300)
COVIDplotInfections60prop <- infection_plot_prop(COVIDoutGrouped, "COVID Infections Proportion (60 days)", 0, 60)
ggsave("figures/COVIDplotInfections60prop.png", width = 10, height = 7, dpi = 300)

COVIDplotInfections500ct <- infection_plot(COVIDoutGrouped, "COVID Infections Count (500 days)", 0, 500)
ggsave("figures/COVIDplotInfections500ct.png", width = 10, height = 7, dpi = 300)
COVIDplotInfections500prop <- infection_plot_prop(COVIDoutGrouped, "COVID Infections Proportion (500 days)", 0, 500)
ggsave("figures/COVIDplotInfections500prop.png", width = 10, height = 7, dpi = 300)

COVIDplotInfections5yrct <- infection_plot(COVIDoutGrouped, "COVID Infections Count (5 years)", 1826, 2192)
ggsave("figures/COVIDplotInfections5yrct.png", width = 10, height = 7, dpi = 300)
COVIDplotInfections5yrprop <- infection_plot_prop(COVIDoutGrouped, "COVID Infections Proportion (5 years)", 1826, 2192)
ggsave("figures/COVIDplotInfections5yrprop.png", width = 10, height = 7, dpi = 300)

COVIDplotInfections10yrct <- infection_plot(COVIDoutGrouped, "COVID Infections Count (10 years)", 3653, NULL)
ggsave("figures/COVIDplotInfections10yrct.png", width = 10, height = 7, dpi = 300)
COVIDplotInfections10yrprop <- infection_plot_prop(COVIDoutGrouped, "COVID Infections Proportion (10 years)", 3653, NULL)
ggsave("figures/COVIDplotInfections10yrprop.png", width = 10, height = 7, dpi = 300)
```


### Flu

## Calibrate Seasonality 

```{R}

flu_parms_full = get_parms(flu_parms, "No Vaccination", "Flu")

flu_start = list(
  mu_janmar = 0.04, 
  mu_aprjun = 0.04, 
  mu_julsep = 0.04, 
  mu_octdec = 0.04, 
  sig_dist = 0.2)

flu_upper_limit = list(
  mu_janmar = 1.5, 
  mu_aprjun = 1.5, 
  mu_julsep = 1.5, 
  mu_octdec = 1.5, 
  sig_dist = 2
)

flu_lower_limit = list(
  mu_janmar = 0.01, 
  mu_aprjun = 0.01, 
  mu_julsep = 0.01, 
  mu_octdec = 0.01, 
  sig_dist = 0.05
)

flu_m1_A = mle2(minuslogl = loglik,
              start = flu_start,
              data = flu_mortality,
              method = "L-BFGS-B",
              #fixed = list(mu = 0.03),
              upper= flu_upper_limit,
              lower = flu_lower_limit,
              control=list(maxit=20000, trace=TRUE, parscale=abs(unlist(flu_start))))
```

```{R}
FLUNoVac <- run_ode(init, seir, times, flu_parms, "No Vaccination", "Flu")
FLUCurrVac <- run_ode(init, seir, times, flu_parms, "Current Vaccination", "Flu")
FLUSameVac <- run_ode(init, seir, times, flu_parms, "Same Vaccination", "Flu")
```

```{R}
# make new dataframe with infections for each group
FLUout <- rbind(FLUNoVac, FLUCurrVac, FLUSameVac) 
# filter so only infections
FLUoutGrouped <- FLUout %>% filter(str_starts(name, "I_")) %>%
            group_by(time, type, group) %>%
            summarise(infections = sum(value)) %>%
            mutate(proportion = infections / total_pop[group])

FLUoutGrouped$type <- factor(FLUoutGrouped$type, levels=c('No Vaccination', 'Current Vaccination', 'Same Vaccination'))
```

```{R}
FLUplotInfections60ct <- infection_plot(FLUoutGrouped, "Flu Infections Count (60 days)", 0, 60)
ggsave("figures/FLUplotInfections60ct.png", width = 10, height = 7, dpi = 300)
FLUplotInfections60prop <- infection_plot_prop(FLUoutGrouped, "Flu Infections Proportion (60 days)", 0, 60)
ggsave("figures/FLUplotInfections60prop.png", width = 10, height = 7, dpi = 300)

FLUplotInfections500ct <- infection_plot(FLUoutGrouped, "Flu Infections Count (500 days)", 0, 500)
ggsave("figures/FLUplotInfections500ct.png", width = 10, height = 7, dpi = 300)
FLUplotInfections500prop <- infection_plot_prop(FLUoutGrouped, "Flu Infections Proportion (500 days)", 0, 500)
ggsave("figures/FLUplotInfections500prop.png", width = 10, height = 7, dpi = 300)

FLUplotInfections5yrct <- infection_plot(FLUoutGrouped, "Flu Infections Count (5 years)", 1826, 2192)
ggsave("figures/FLUplotInfections5yrct.png", width = 10, height = 7, dpi = 300)
FLUplotInfections5yrprop <- infection_plot_prop(FLUoutGrouped, "Flu Infections Proportion (5 years)", 1826, 2192)
ggsave("figures/FLUplotInfections5yrprop.png", width = 10, height = 7, dpi = 300)

FLUplotInfections10yrct <- infection_plot(FLUoutGrouped, "Flu Infections Count (10 years)", 3653, NULL)
ggsave("figures/FLUplotInfections10yrct.png", width = 10, height = 7, dpi = 300)
FLUplotInfections10yrprop <- infection_plot_prop(FLUoutGrouped, "Flu Infections Proportion (10 years)", 3653, NULL)
ggsave("figures/FLUplotInfections10yrprop.png", width = 10, height = 7, dpi = 300)
```

### RSV
```{R}
# ODE setup
RSVNoVac <- run_ode(init, seir, times, rsv_parms, "No Vaccination", "RSV")
RSVCurrVac <- run_ode(init, seir, times, rsv_parms, "Current Vaccination", "RSV")
RSVSameVac <- run_ode(init, seir, times, rsv_parms, "Same Vaccination", "RSV")

# Combine DF
# make new dataframe with infections for each group
RSVout <- rbind(RSVNoVac, RSVCurrVac, RSVSameVac) 
# filter so only infections
RSVoutGrouped <- RSVout %>% filter(str_starts(name, "I_")) %>%
            group_by(time, type, group) %>%
            summarise(infections = sum(value)) %>%
            mutate(proportion = infections / total_pop[group])

RSVoutGrouped$type <- factor(RSVoutGrouped$type, levels=c('No Vaccination', 'Current Vaccination', 'Same Vaccination'))
```

```{R}
RSVplotInfections60ct <- infection_plot(RSVoutGrouped, "RSV Infections Count (60 days)", 0, 60)
ggsave("figures/RSVplotInfections60ct.png", width = 10, height = 7, dpi = 300)
RSVplotInfections60prop <- infection_plot_prop(RSVoutGrouped, "RSV Infections Proportion (60 days)", 0, 60)
ggsave("figures/RSVplotInfections60prop.png", width = 10, height = 7, dpi = 300)

RSVplotInfections500ct <- infection_plot(RSVoutGrouped, "RSV Infections Count (500 days)", 0, 500)
ggsave("figures/RSVplotInfections500ct.png", width = 10, height = 7, dpi = 300)
RSVplotInfections500prop <- infection_plot_prop(RSVoutGrouped, "RSV Infections Proportion (500 days)", 0, 500)
ggsave("figures/RSVplotInfections500prop.png", width = 10, height = 7, dpi = 300)

RSVplotInfections5yrct <- infection_plot(RSVoutGrouped, "RSV Infections Count (5 years)", 1826, 2192)
ggsave("figures/RSVplotInfections5yrct.png", width = 10, height = 7, dpi = 300)
RSVplotInfections5yrprop <- infection_plot_prop(RSVoutGrouped, "RSV Infections Proportion (5 years)", 1826, 2192)
ggsave("figures/RSVplotInfections5yrprop.png", width = 10, height = 7, dpi = 300)

RSVplotInfections10yrct <- infection_plot(RSVoutGrouped, "RSV Infections Count (10 years)", 3653, NULL)
ggsave("figures/RSVplotInfections10yrct.png", width = 10, height = 7, dpi = 300)
RSVplotInfections10yrprop <- infection_plot_prop(RSVoutGrouped, "RSV Infections Proportion (10 years)", 3653, NULL)
ggsave("figures/RSVplotInfections10yrprop.png", width = 10, height = 7, dpi = 300)
```

### Pertussis 
```{R}
# ODE setup
PERTNoVac <- run_ode(init, seir, times, pertussis_parms, "No Vaccination", "Pertussis")
PERTCurrVac <- run_ode(init, seir, times, pertussis_parms, "Current Vaccination", "Pertussis")
PERTSameVac <- run_ode(init, seir, times, pertussis_parms, "Same Vaccination", "Pertussis")

# Combine DF
# make new dataframe with infections for each group
PERTout <- rbind(PERTNoVac, PERTCurrVac, PERTSameVac) 
# filter so only infections
PERToutGrouped <- PERTout %>% filter(str_starts(name, "I_")) %>%
            group_by(time, type, group) %>%
            summarise(infections = sum(value)) %>%
            mutate(proportion = infections / total_pop[group])

PERToutGrouped$type <- factor(PERToutGrouped$type, levels=c('No Vaccination', 'Current Vaccination', 'Same Vaccination'))
```

```{R}
PERTplotInfections60ct <- infection_plot(PERToutGrouped, "Pertussis Infections Count (60 days)", 0, 60)
ggsave("figures/PERTplotInfections60ct.png", width = 10, height = 7, dpi = 300)
PERTplotInfections60prop <- infection_plot_prop(PERToutGrouped, "Pertussis Infections Proportion (60 days)", 0, 60)
ggsave("figures/PERTplotInfections60prop.png", width = 10, height = 7, dpi = 300)

PERTplotInfections500ct <- infection_plot(PERToutGrouped, "Pertussis Infections Count (500 days)", 0, 500)
ggsave("figures/PERTplotInfections500ct.png", width = 10, height = 7, dpi = 300)
PERTplotInfections500prop <- infection_plot_prop(PERToutGrouped, "Pertussis Infections Proportion (500 days)", 0, 500)
ggsave("figures/PERTplotInfections500prop.png", width = 10, height = 7, dpi = 300)

PERTplotInfections5yrct <- infection_plot(PERToutGrouped, "Pertussis Infections Count (5 years)", 1826, 2192)
ggsave("figures/PERTplotInfections5yrct.png", width = 10, height = 7, dpi = 300)
PERTplotInfections5yrprop <- infection_plot_prop(PERToutGrouped, "Pertussis Infections Proportion (5 years)", 1826, 2192)
ggsave("figures/PERTplotInfections5yrprop.png", width = 10, height = 7, dpi = 300)

PERTplotInfections10yrct <- infection_plot(PERToutGrouped, "Pertussis Infections Count (10 years)", 3653, NULL)
ggsave("figures/PERTplotInfections10yrct.png", width = 10, height = 7, dpi = 300)
PERTplotInfections10yrprop <- infection_plot_prop(PERToutGrouped, "Pertussis Infections Proportion (10 years)", 3653, NULL)
ggsave("figures/PERTplotInfections10yrprop.png", width = 10, height = 7, dpi = 300)
```