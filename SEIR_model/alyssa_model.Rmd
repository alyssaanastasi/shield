---
title: "SEIR Model with Vaccination"
author: "Alyssa Anastasi"
date: "`r format(Sys.time(), '%B %Y')`"
  output:
  pdf_document: default
  html_document: default
---

## Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(deSolve)
library(tidyverse)
library(MetBrewer)
library(directlabels)
library(cowplot)
library(viridis)
library(RColorBrewer)
library(MetBrewer)
library(ggrepel)
library(spatstat.utils)
library(paletteer)
source("alyssa_seir.R")
source("alyssa_SEIR_params.R")
```


## Time Parms
```{r}
times <- 1:500
```

## DataFrame Set Up Function Using ODE
```{r}
run_ode <- function(init, seir, times, parms, vacc_type, disease) {
  vaccs <- set_vacc(disease, vacc_type)
  full_parms <- c(parms, vaccs)
  df <- ode(y=init, func = seir, times=times, parms = full_parms) %>% 
  as.data.frame() %>% as_tibble() %>% pivot_longer(-time) %>%
  mutate(name = fct_relevel(name, names(init)),
         type = vacc_type) %>%
  mutate(group = case_when(
      grepl("^S_C1|^S_C2|^E_C1|^E_C2|^I_C1|^I_C2|^E_C2|^R_C1|^R_C2|^D_C1|^D_C2", name) ~ "Children",
      grepl("^S_CA|^E_CA|^I_CA|^R_CA|^D_CA", name) ~ "Childless Adults",
      grepl("^S_P|^E_P|^I_P|^R_P|^D_P", name) ~ "Adults with Children (Parents)",
      grepl("^S_S|^E_S|^I_S|^R_S|^D_S", name) ~ "Adults (50+)",
  )) %>%
    mutate(label = case_when(
      grepl("^S_.*1$", name) ~ "Susceptible (First)",
      grepl("^S_.*2$", name) ~ "Susceptible (Second)",
      grepl("^E_.*1$", name) ~ "Exposed (First)",
      grepl("^E_.*2$", name) ~ "Exposed (Second)",
      grepl("^I_.*1$", name) ~ "Infected (First)",
      grepl("^I_.*2$", name) ~ "Infected (Second)",
      grepl("^R_.*1$", name) ~ "Recovered (First)",
      grepl("^R_.*2$", name) ~ "Recovered (Second)",
      grepl("^D_.*1$", name) ~ "Dead (First)",
      grepl("^D_.*2$", name) ~ "Dead (Second)"
  ))
  return(df)
}
```

## Plot Functions
```{R}
full_plot <- function(df, title)
  df %>% drop_na(label) %>% ggplot(aes(x=time,y=value, color=label)) + 
  geom_line() + 
  facet_wrap(~group, scales = "free", ncol = 2) +
  ggtitle(title) + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        legend.key.width=unit(0.3,"cm"),
        legend.key.height =unit(0.6,"cm"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        legend.title = element_text(colour = "black", size = 10),
        legend.text = element_text(colour = "black", size = 9),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="gray95", fill="gray95"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"))

infection_plot <- function(df, title, max_time) {
  if (is.null(max_time)) {
    max_time = max(times) + 1
  }
  df %>% filter(time < max_time) %>%
  ggplot(aes(x=time, y=infections, color=type)) +
  geom_line() + 
  scale_color_paletteer_d("MoMAColors::Andri") +
  facet_wrap(~group, ncol = 2) +
  ggtitle(title) + 
  labs(x = "Time (Days)", y = "Infections", color = "Vaccination Coverage") + 
  theme_bw() +
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        legend.key.width=unit(0.3,"cm"),
        legend.key.height =unit(0.6,"cm"),
        plot.title = element_text(colour = "black", size = 15, face = "bold"),
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        legend.title = element_text(colour = "black", size = 9),
        legend.text = element_text(colour = "black", size = 8),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="gray95", fill="gray95", linetype=1),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"))
}

```

## Vaccination Functions
```{R}
set_vacc <- function(disease, type) {
  WVH <- 15
  k <- 1.75
  if (type == "No Vaccination"){
    vaccC <- function(t){0}
    vaccCA <- function(t){0}
    vaccP <- function(t){0}
    vaccS <- function(t){0}
  } else if (disease == "COVID-19" && type == "Current Vaccination") {
    vaccC <- vacc_weekly(0.559, WVH, k)
    vaccCA <- vacc_weekly(0.73, WVH, k)
    vaccP <- vacc_weekly(0.758, WVH, k)
    vaccS <- vacc_weekly(0.858, WVH, k)
  } else if (disease == "COVID-19" && type == "Same Vaccination") {
    vaccC <- vacc_weekly(0.758, WVH, k)
    vaccCA <- vacc_weekly(0.758, WVH, k)
    vaccP <- vacc_weekly(0.758, WVH, k)
    vaccS <- vacc_weekly(0.858, WVH, k)
  } else if (disease == "Flu" && type == "Current Vaccination") {
    vaccC <- vacc_weekly(0.531, WVH, k)
    vaccCA <- vacc_weekly(0.356, WVH, k)
    vaccP <- vacc_weekly(0.477, WVH, k)
    vaccS <- vacc_weekly(0.599, WVH, k)
  } else if (disease == "Flu" && type == "Same Vaccination") {
    vaccC <- vacc_weekly(0.531, WVH, k)
    vaccCA <- vacc_weekly(0.531, WVH, k)
    vaccP <- vacc_weekly(0.531, WVH, k)
    vaccS <- vacc_weekly(0.599, WVH, k)
  }
  return(c(vaccC = vaccC, vaccCA = vaccCA, vaccP = vaccP, vaccS = vaccS))
}

```

### COVID
```{r}
COVIDNoVac <- run_ode(init, seir, times, covid_parms, "No Vaccination", "COVID-19")
COVIDplotNoVac <- full_plot(COVIDNoVac, "COVID-19 - No Vaccination")
ggsave("figures/COVIDNoVac.png", width = 10, height = 7, dpi = 300)

COVIDCurrVac <- run_ode(init, seir, times, covid_parms, "Current Vaccination", "COVID-19")
COVIDplotCurrVac <- full_plot(COVIDCurrVac, "COVID-19 - Current Vaccination")
ggsave("figures/COVIDCurrVac.png", width = 10, height = 7, dpi = 300)

COVIDSameVac <- run_ode(init, seir, times, covid_parms, "Same Vaccination", "COVID-19")
COVIDplotSameVac <- full_plot(COVIDSameVac, "COVID-19 - Same Vaccination")
ggsave("figures/COVIDSameVac.png", width = 10, height = 7, dpi = 300)
```

### Flu

```{R}
FLUNoVac <- run_ode(init, seir, times, flu_parms, "No Vaccination", "Flu")
FLUplotNoVac <- full_plot(FLUNoVac, "Flu - No Vaccination")
ggsave("figures/FLUNoVac.png", width = 10, height = 7, dpi = 300)

FLUCurrVac <- run_ode(init, seir, times, flu_parms, "Current Vaccination", "Flu")
FLUplotCurrVac <- full_plot(FLUCurrVac, "Flu - Current Vaccination")
ggsave("figures/FLUCurrVac.png", width = 10, height = 7, dpi = 300)

FLUSameVac <- run_ode(init, seir, times, flu_parms, "Same Vaccination", "Flu")
FLUplotSameVac <- full_plot(FLUSameVac, "Flu - Same Vaccination")
ggsave("figures/FLUSameVac.png", width = 10, height = 7, dpi = 300)
```

## Infection Curves

### COVID-19
```{R}
# make new dataframe with infections for each group
COVIDout <- rbind(COVIDNoVac, COVIDCurrVac, COVIDSameVac) 
# filter so only infections
COVIDoutGrouped <- COVIDout %>% filter(str_starts(name, "I_")) %>%
            group_by(time, type, group) %>%
            summarise(infections = sum(value))

COVIDoutGrouped$type <- factor(COVIDoutGrouped$type, levels=c('No Vaccination', 'Current Vaccination', 'Same Vaccination'))
```

```{R}
COVIDplotInfections60 <- infection_plot(COVIDoutGrouped, "COVID-19 Infections (60 days)", 60)
ggsave("figures/COVIDplotInfections60.png", width = 10, height = 7, dpi = 300)

COVIDplotInfections <- infection_plot(COVIDoutGrouped, "COVID-19 Infections (500 days)", NULL)
ggsave("figures/COVIDplotInfections.png", width = 10, height = 7, dpi = 300)
```


### Flu
```{R}
# make new dataframe with infections for each group
FLUout <- rbind(FLUNoVac, FLUCurrVac, FLUSameVac) 
# filter so only infections
FLUoutGrouped <- FLUout %>% filter(str_starts(name, "I_")) %>%
            group_by(time, type, group) %>%
            summarise(infections = sum(value))

FLUoutGrouped$type <- factor(FLUoutGrouped$type, levels=c('No Vaccination', 'Current Vaccination', 'Same Vaccination'))
```

```{R}
FLUplotInfections60 <- infection_plot(FLUoutGrouped, "Flu Infections (60 days)", 60)
ggsave("figures/FLUplotInfections60.png", width = 10, height = 7, dpi = 300)

FLUplotInfections <- infection_plot(FLUoutGrouped, "Flu Infections (500 days)", NULL)
ggsave("figures/FLUplotInfections.png", width = 10, height = 7, dpi = 300)
```