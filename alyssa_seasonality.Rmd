---
title: "alyssa_seasonality"
author: "Alyssa Anastasi"
date: "2025-06-10"
output: html_document
---

# Log Likelihood FN
```{R}
loglik <- function(
    mu_janapr, mu_mayaug, mu_septdec,
    alpha,
    risk_old_h, risk_child_h,
    sig_dist
){
  
  # First, feed in standard parms
  paras <- run_parms
  # update death rate, hospitalization risks
  paras["alpha"] <- alpha
  paras["risk_old_h"] <- risk_old_h
  paras["risk_child_h"] <- risk_child_h
  # set seasonality
  set_mat <- seas_matrix(mu_janapr, mu_mayaug, mu_septdec)
  ## make sure mu is defined globally so that it actually passes into the seir function
  mu <<- function(t){
    seas_function(t, matrix = set_mat)
  }
  
  # set initial conditions
  init <- run_init
 
  # Set times
  times <- 92:481
  
  # vec_print <- c(mu_janfeb, mu_marapr, mu_mayjun, 
  #                mu_julaug, mu_septoct, mu_novdec,
  #                alpha,
  #                sig_dist)
  # 
  # print("------- PARAS --------")
  # print(vec_print)
  
  # Run the model 
  out_calib1 <- ode(y=init, func = seir, times=times, parms = paras, method = "euler") %>%
    as.data.frame() %>%
    as_tibble() %>%
    select(time, 
           Hosp_1_child, Hosp_2_child,Hosp_3_child,
           D_1_child, D_2_child, D_2E_child, D_3_child, D_3E_child,
           Hosp_1_adult, Hosp_2_adult,Hosp_3_adult,
           D_1_adult, D_2_adult, D_2E_adult, D_3_adult, D_3E_adult,
           Hosp_1_old, Hosp_2_old,Hosp_3_old,
           D_1_old, D_2_old, D_2E_old, D_3_old, D_3E_old,
           Hosp_1_hr, Hosp_2_hr, Hosp_3_hr,
           D_1_hr, D_2_hr, D_2E_hr, D_3_hr, D_3E_hr
           ) %>%
    group_by(time) %>%
    reframe(
            `inc hosp_0-64` = Hosp_1_adult + Hosp_2_adult + Hosp_3_adult + Hosp_1_child + Hosp_2_child + Hosp_3_child + Hosp_1_hr + Hosp_2_hr + Hosp_3_hr,
            `inc nhsn_0-17` = Hosp_1_child + Hosp_2_child + Hosp_3_child,
            `inc nhsn_18-64` = Hosp_1_adult + Hosp_2_adult + Hosp_3_adult + Hosp_1_hr + Hosp_2_hr + Hosp_3_hr,
            `inc hosp_65-130` = Hosp_1_old + Hosp_2_old + Hosp_3_old,
            `inc nhsn_65-130` = Hosp_1_old + Hosp_2_old + Hosp_3_old,
            `inc hosp_0-130` = `inc hosp_0-64` + `inc hosp_65-130`,
            `inc death_0-64` = D_1_adult + D_2_adult + D_2E_adult + D_3_adult + D_3E_adult + D_1_child + D_2_child + D_2E_child +  D_3_child + D_3E_child + D_1_hr + D_2_hr + D_2E_hr + D_3_hr + D_3E_hr,
            `inc death_65-130` = D_1_old + D_2_old + D_2E_old +  D_3_old + D_3E_old,
            `inc death_0-130` = `inc death_0-64` + `inc death_65-130`
            ) %>%
    ungroup() %>%
    pivot_longer(-time) %>%
    separate(name, into = c("target", "age_group"), sep = "_") %>%
    group_by(target, age_group) %>%
    arrange(time) %>%
    mutate(value = value - lag(value, 7)) %>% ## weekly
    ungroup() %>%
    mutate(date = as.Date("01-01-2024", "%m-%d-%Y") + time) %>%
    select(-time) %>%
    right_join(data, by = c("target", "age_group", "date")) %>%
  # Normalize the data. Here, I'm using the maximum in the observed data for each target and 
  # age combination. This step is very important. Without it, the MLE weights targets and age differently,
  # and doesn't converge. 
    group_by(target, age_group) %>%
    arrange(date) %>%
    mutate(max_normal = max(observation, na.rm = T),
           observation = observation/max_normal,
           value = value/max_normal) %>%
    filter(!is.na(observation), !is.na(value)) %>%
    ungroup()
  
  # Now get the negative log likelihood. Note we are concurrently fitting the sd
  ll <- -sum(dnorm(x=out_calib1$value,mean=out_calib1$observation,sd=sig_dist,log=TRUE))
  
  # This code ensures that if the output of the log likelihood is NA, the MLE won't stop. Instead it will return
  # an extremely large, positive value of the negative log likelihood and keep iterating.
  ll_final = if_else(is.na(ll), 10^6, ll)
  
  return(ll_final)
}
```



# COVID-19 Seasonality

```{R}
covid_mortality <- read.csv("data/COVID_mortality.csv")
```