---
title: "SurveyAnalysis_Alyssa"
author: "Chloe Yang"
date: "2025-02-05"
output: html_document
---

# setup

```{r setup, include = TRUE}
#### GENERAL ######
library(tidyverse)
library(readxl) ## read excel files
library(broom)
library(rlang) #convert string to variable


##### STATISTICS ####
library(Hmisc)
library(oce)
library(zoo)
library(spatstat.utils)
library(Metrics)
library(skimr)
library(ggpubr)
library(reshape2)
library(tigris)
library(lubridate)
library(sf)
library(nnet)


######## PALETTES ######
library(RColorBrewer) 
library(wesanderson)
library(ghibli)
library(NatParksPalettes)
library(viridis)
library(MetBrewer)
library(PNWColors)

####### PLOT MACHINERY ######
library(directlabels)
library(cowplot)
library(scales)
library(patchwork)
library(ggh4x)
library(ggrepel)
library(svglite)
```

# load data

<!-- ## Segregation data -->

<!-- ```{r} -->

<!-- ## for county level hypersegregation -->

<!-- hypersegregation <- read_csv("../data/processed data/aggregate/OEPS_sociodem_data.csv") %>%  -->

<!--   mutate(location = gsub("St. Clair","St Clair", location)) %>% -->

<!--   mutate(location = paste(location, "County")) %>% -->

<!--   mutate(location = str_to_title(location)) %>% -->

<!--   filter(name == "binary_hypersegragation") %>%  -->

<!--   select(location, sociodem = value) %>% -->

<!--   mutate(hypersegregated = if_else(sociodem == 1, "Yes", "No")) %>% -->

<!--   select(location, hypersegregated) -->

<!-- ## for county dissimilarity indices -->

<!-- FIPS_codes <- read_csv("../data/kjhealy_fips_codes/county_fips_master.csv") %>% -->

<!--   filter(state_abbr == "IL") %>% -->

<!--   select(fips = 1, location = 2) %>% -->

<!--   mutate(fips = as.numeric(fips)) %>% -->

<!--   mutate(location = str_to_title(location)) %>% -->

<!--   mutate(location = gsub("St. Clair","St Clair", location)) -->

<!-- ## for pop by race in each county -->

<!-- weight_dissim_by_race <- read_csv("../data/processed data/aggregate/OEPS_sociodem_data.csv") %>%  -->

<!--   mutate(location = gsub("St. Clair","St Clair", location)) %>% -->

<!--   mutate(location = paste(location, "County")) %>% -->

<!--   mutate(location = str_to_title(location)) %>% -->

<!--   filter(name %in% c("black_perc", "asian_perc", "hispanic_per")) %>%  -->

<!--   mutate(value = as.numeric(value)) %>% -->

<!--   filter(geography == "County") %>% -->

<!--   select(-source, -geography) %>% -->

<!--   pivot_wider(names_from = name, values_from = value) %>% -->

<!--   mutate(location = str_to_title(location)) %>% -->

<!--   mutate(location = gsub("St. Clair","St Clair", location)) -->

<!-- ## within-county dissimilarity ranging from 0 (complete integration) to 1 (complete segregation) -->

<!-- dissim <- read_csv("../data/OEPS/OEPS_DOWNLOAD_2024-05-15/data/BE05_C.csv") %>%  -->

<!--   rename(fips = 1) %>% -->

<!--   mutate(fips = as.numeric(fips)) %>% -->

<!--   inner_join(FIPS_codes, by = "fips") %>% -->

<!--   mutate(location = gsub("St. Clair","St Clair", location)) %>% -->

<!--   left_join(weight_dissim_by_race) %>% -->

<!--   mutate(dissimilarity= (black_perc*dissim.b + hispanic_per*dissim.h + asian_perc*dissim.a)/(black_perc + hispanic_per + asian_perc)) %>% -->

<!--   mutate(dissimilarity = dissimilarity) %>% -->

<!--   select(location, dissimilarity) -->

<!-- ## for zip to county -->

<!-- IL_zip_to_county <- read_csv("../data/Illinois Data Portal/IllinoisData_Zip_to_Fip.csv") %>% -->

<!--   mutate(location = str_to_title(county)) %>% -->

<!--   mutate(location = paste(location, "County")) %>% -->

<!--   select(location, zipcode) -->

<!-- seg_zips <- IL_zip_to_county %>%  -->

<!--   left_join(dissim) %>% -->

<!--   left_join(hypersegregation) -->

<!-- ``` -->

## Wave 1 - cleaning

```{r}
survey_wave1 <- read_csv("data/Health Behavior and Demographics - Fielding_December 4, 2024_13.23.csv") 

finished <- survey_wave1 %>%
  filter(StartDate!= "Start Date", substr(StartDate,0,1) != "{") %>%
  pivot_longer(12:119) %>%
  filter(!(name %in% c("Q1/2", "Q1/2_5_TEXT", "Q3", "Q4", "Q5", "Q5_6_TEXT", "Q6a"))) %>% 
  filter(substr(name, 0,4) != "Q6b#") %>%
  filter(Finished == "True") %>%
  group_by(psid) %>%
  mutate(count_score = if_else(is.na(value), 0, 1)) %>%
  mutate(count_score = sum(count_score)) %>%
  ungroup() %>% 
  filter(count_score > 0)
get_bots <- finished %>% 
  filter(Q_RecaptchaScore <= 0.5) %>%
  select(Q_RecaptchaScore, psid) %>% distinct() %>%
  select(psid) %>% distinct()

get_all_completes <- finished %>% 
  select(psid) %>% distinct()

get_completes_to_filter <- finished %>% 
  select(psid, StartDate, EndDate, ResponseId)

## we need to filter out first response of duplicate responses - for wave 1 these are conveniently all captured by bot psids
survey_wave1 <- survey_wave1 %>%
  inner_join(get_completes_to_filter, by = c("psid", "StartDate", "EndDate", "ResponseId")) %>%
  filter(!(psid %in% get_bots$psid))


get_clean_ages <- survey_wave1 %>%
  select(`Q3`) %>% distinct() %>%
  mutate(old = `Q3`) %>%
  mutate(
    `Q3` = 
      case_when(
        (grepl("/",`Q3`) | grepl(" ",`Q3`) | grepl("-",`Q3`)) == T & str_length(`Q3`) == 10 ~ substr(`Q3`,7,10),
        (grepl("/",`Q3`) | grepl(" ",`Q3`) | grepl("-",`Q3`)) == T & str_length(`Q3`) == 8 ~ substr(`Q3`, 7, 8),
        (grepl("/",`Q3`) | grepl(" ",`Q3`) | grepl("-",`Q3`)) == T & str_length(`Q3`) == 7 ~ substr(`Q3`, 4, 7),
        (grepl("/",`Q3`) | grepl(" ",`Q3`) | grepl("-",`Q3`)) == F & str_length(`Q3`) == 4 ~ `Q3`,
        (grepl("/",`Q3`) | grepl(" ",`Q3`) | grepl("-",`Q3`)) == T & str_length(`Q3`) == 5 ~ substr(`Q3`, 4, 5)
      )
  ) %>%
  mutate(`Q3` = if_else(`Q3` %in% c("01", "02","05"), paste("20", `Q3`, sep = ""), `Q3`)) %>%
  mutate(`Q3` = if_else(old == "11-07-91", "1991", `Q3`),
         `Q3` = if_else(old == "6 4 1988", "1988", `Q3`),
         `Q3` = if_else(old == "03/83", "1983", `Q3`),
         `Q3` = if_else(old == "4/4/1974", "1974", `Q3`),
         `Q3` = if_else(old == "11/22/66", "1966", `Q3`),
         `Q3` = if_else(old == "6/16/2005", "2005", `Q3`),
         `Q3` = if_else(old == "09/071994", "1994", `Q3`),
         `Q3` = if_else(old == "may 18,2009", "2009", `Q3`),
         `Q3` = if_else(old == "06-121988", "1988", `Q3`),
         `Q3` = if_else(old == "9/29/2005", "2005", `Q3`),
         `Q3` = if_else(old == "1/24/2006", "2006", `Q3`),
         `Q3` = if_else(old == "11 /03 / 1980", "1980", `Q3`),
         `Q3` = if_else(old == "1-14-1982", "1982", `Q3`),
         `Q3` = if_else(old == "12/6/8", "2008", `Q3`)
         ) %>%
  mutate(`Q3` = as.numeric(`Q3`)) %>%
  rename(YofB = `Q3`, `Q3` = old)

survey_wave1 <- survey_wave1 %>%
  mutate(`Q1/2_5_TEXT` = gsub("+60477", "60477", `Q1/2_5_TEXT`)) %>%
  left_join(get_clean_ages) %>%
  filter(!is.na(YofB)) %>% select(-`Q3`) %>%
  filter(YofB < 2005 & YofB > 1900) %>%
  select(-`Q1/2`) %>%
  rename(
    zipcode = `Q1/2_5_TEXT`,
    gender = `Q4`,
    household_size = `Q5`,
    household_size_text = `Q5_6_TEXT`,
    children_in_household = `Q6a`,
    household1_age = `Q6b#1_1_1`,
    household2_age = `Q6b#1_2_1`,
    household3_age = `Q6b#1_3_1`,
    household4_age = `Q6b#1_4_1`,
    household5_age = `Q6b#1_5_1`,
    household1_race = `Q6b#2_1`,
    household2_race = `Q6b#2_2`,
    household3_race = `Q6b#2_3`,
    household4_race = `Q6b#2_4`,
    household5_race = `Q6b#2_5`,
    household1_gender = `Q6b#3_1`,
    household2_gender = `Q6b#3_2`,
    household3_gender = `Q6b#3_3`,
    household4_gender = `Q6b#3_4`,
    household5_gender = `Q6b#3_5`,
    child_age = `Q34`,
    child_health_score = `Q35`,
    child_activity_score = `Q36`,
    child_vaccinated_covid = `Q37`,
    child_which_covid_vaccines = `Q38`,
    child_why_no_covid_vaccines = `Q39`,
    child_why_no_covid_vaccines_text = `Q39_13_TEXT`,
    child_why_yes_covid_vaccines = `Q40`,
    child_why_yes_covid_vaccines_text = `Q40_5_TEXT`,
    child_vaccinated_flu = `Q41`,
    child_why_no_flu_vaccines = `Q42`,
    child_why_no_flu_vaccines_text = `Q42_13_TEXT`,
    child_why_yes_flu_vaccines = `Q43`,
    child_why_yes_flu_vaccines_text = `Q43_5_TEXT`,
    child_antibody_RSV = `Q44`,
    child_why_no_RSV = `Q45`,
    child_why_no_RSV_text = `Q45_14_TEXT`,
    child_why_yes_RSV = `Q45b`,
    child_why_yes_RSV_TEXT = `Q45b_7_TEXT`,
    child_illness = `Q46`,
    child_medical_care = `Q47`,
    child_why_no_medical_care = `Q48`,
    child_why_no_medical_care_text = `Q48_8_TEXT`,
    child_reduced_contact = `Q49`,
    child_why_no_reduced_contact = `Q50`,
    child_why_no_reduced_contact_text = `Q50_5_TEXT`,
    child_why_yes_reduced_contact = `Q50b`,
    child_why_yes_reduced_contact_text = `Q50b_4_TEXT`,
    self_health_score = `Q7`,
    self_activity_score = `Q8`,
    self_concern_COVID = `Q9#1_1`,
    self_concern_flu = `Q9#1_2`,
    self_concern_RSV = `Q9#1_3`,
    self_behavior_changed_COVID = `Q9#2_1`,
    self_behavior_changed_flu = `Q9#2_2`,
    self_behavior_changed_RSV = `Q9#2_3`,
    self_covid_tested = `Q10`,
    self_where_covid_tested = `Q11`,
    self_where_covid_tested_text = `Q11_3_TEXT`,
    self_why_no_covid_testing = `Q12`,
    self_why_no_covid_testing_text = `Q12_7_TEXT`,
    self_aware_of_SHIELD = `Q13`,
    self_vaccinated_covid = `Q14`,
    self_which_covid_vaccines = `Q15`,
    self_why_no_covid_vaccines = `Q16`,
    self_why_no_covid_vaccines_text = `Q16_13_TEXT`,
    self_why_yes_covid_vaccines = `Q17`,
    self_why_yes_covid_vaccines_text = `Q17_7_TEXT`,
    self_vaccinated_flu = `Q18`,
    self_why_no_flu_vaccines = `Q19`,
    self_why_no_flu_vaccines_text = `Q19_13_TEXT`,
    self_why_yes_flu_vaccines = `Q20`,
    self_why_yes_flu_vaccines_text = `Q20_7_TEXT`,
    self_illness = `Q21`,
    self_covid_medical_care = `Q22`,
    self_why_no_covid_medical_care = `Q23`,
    self_why_no_covid_medical_care_text = `Q23_8_TEXT`,
    self_covid_reduced_contact = `Q24`,
    self_why_no_covid_reduced_contact = `Q25`,
    self_why_no_covid_reduced_contact_text = `Q25_5_TEXT`,
    self_why_yes_covid_reduced_contact = `Q25b`,
    self_why_yes_covid_reduced_contact_text = `Q25b_5_TEXT`,
    self_flu_medical_care = `Q26`,
    self_why_no_flu_medical_care = `Q27`,
    self_why_no_flu_medical_care_text = `Q27_8_TEXT`,
    self_flu_reduced_contact = `Q28`,
    self_why_no_flu_reduced_contact = `Q29`,
    self_why_no_flu_reduced_contact_text = `Q29_5_TEXT`,
    self_why_yes_flu_reduced_contact = `Q29b...102`,
    self_why_yes_flu_reduced_contact_text = `Q29b_5_TEXT`,
    self_general_medical_care = `Q30`,
    self_why_no_general_medical_care = `Q31`,
    self_why_no_general_medical_care_text = `Q31_8_TEXT`,
    self_general_reduced_contact = `Q32`,
    self_why_no_general_reduced_contact = `Q33`,
    self_why_no_general_reduced_contact_text = `Q33_5_TEXT`,
    self_why_yes_general_reduced_contact = `Q29b...110`,
    self_why_yes_general_reduced_contact_text = `Q29b_8_TEXT`,
    self_hispanic_latino = `Q51`,
    self_race = `Q52`,
    self_education = `Q53`,
    self_employment = `Q54`,
    self_income = `Q55`,
    self_political_affiliation = `Q56`,
    self_political_ideology = `Q57`,
    self_political_candidate_2020 = `Q58`
  ) %>%
    mutate(YofB = as.character(YofB)) %>%
  relocate(YofB, .before = "zipcode") %>%
  select(psid, YofB:self_political_candidate_2020) %>% distinct()  %>% 
  mutate(YoB = as.numeric(YofB)) %>%
  mutate(respondent_age = case_when(
    YofB > 1937 & YofB <= 1959 ~ "65+",
    YofB > 1959 & YofB <= 1989 ~ "35-65",
    YofB > 1989 & YofB <= 1999 ~ "25-35",
    YofB > 1999 & YofB <= 2006 ~ "18-25",
    is.na(YofB) ~ "Unknown"
  )) 


survey_cleaned <- survey_wave1 %>% 
  mutate(self_race = case_when(
   self_hispanic_latino == "Yes" & grepl(",", self_race) == F ~ "Hispanic/Latino",
   grepl(",", self_race) == T ~ "Multiracial",
   is.na(self_race) ~ "Unknown",
   .default = self_race
  )) %>%
  mutate(child_age = case_when(
    as.numeric(child_age) <= 5 ~ "5 and under",
    as.numeric(child_age) >= 6 ~ "6-18 years",
    is.na(child_age) ~ "No child age given"
  ))
  

grab_demos <- survey_cleaned %>% 
  select(psid, zipcode, self_race, child_age, YofB, respondent_age,
         gender, self_education, self_employment, self_income,
         self_political_affiliation, self_political_ideology,
         self_political_candidate_2020) %>% distinct()
```

```{r}
survey_cleaned <- survey_cleaned %>%
  select(-c(zipcode, self_race, child_age, YofB, respondent_age, 
         gender, self_education, self_employment, self_income,
         self_political_affiliation, self_political_ideology,
         self_political_candidate_2020)) %>%
  pivot_longer(-psid, 
               names_to = "question",
                  values_to = "response", 
                  values_transform = list(response = as.character)) %>% 
  distinct()

multi_answer_list <- c("child_why_no_covid_vaccines",
                         "child_why_yes_covid_vaccines",
                         "child_why_no_flu_vaccines",
                         "child_why_yes_flu_vaccines",
                         "child_why_no_RSV",
                         "child_why_yes_RSV",
                         "child_medical_care",
                         "child_why_no_medical_care",
                         "child_why_no_reduced_contact",
                         "child_why_yes_reduced_contact",
                         "self_where_covid_tested",
                         "self_why_no_covid_testing",
                         "self_why_no_covid_vaccines",
                         "self_why_yes_covid_vaccines",
                         "self_why_no_flu_vaccines",
                         "self_why_yes_flu_vaccines",
                         "self_covid_medical_care",
                         "self_why_no_covid_medical_care",
                         "self_why_no_covid_reduced_contact",
                         "self_why_yes_covid_reduced_contact",
                         "self_flu_medical_care",
                         "self_why_no_flu_medical_care",
                         "self_why_no_flu_reduced_contact",
                         "self_why_yes_flu_reduced_contact",
                         "self_general_medical_care",
                         "self_why_no_general_medical_care",
                         "self_why_no_general_reduced_contact",
                         "self_why_yes_general_reduced_contact")

survey_cleaned_separation <- survey_cleaned %>% 
  filter(question %in% multi_answer_list) %>%
  separate_rows(3,sep = ",")

survey_cleaned_no_separation <- survey_cleaned %>%
  filter(!(question %in% multi_answer_list))

survey_cleaned <- rbind(survey_cleaned_separation, survey_cleaned_no_separation) %>% 
  filter(!is.na(response)) %>%
  distinct() %>%
  mutate(response_counter = 1) %>%
  pivot_wider(names_from = "psid", values_from = "response_counter") %>%
  mutate_at(c(3:3691), ~replace(., is.na(.), 0)) %>%
  pivot_longer(-c(question, response), names_to = "psid", values_to = "response_counter") %>%
  left_join(grab_demos) %>%
  filter(question != "self_hispanic_latino")

## remove rows for questions that someone did not answer, i.e. grouping by question, sum of response = 0
survey_cleaned <- survey_cleaned %>%
  group_by(psid, question) %>%
  filter(sum(response_counter) != 0) %>%
  ungroup() 

## check no repeat psid's

test_duplicates <- survey_cleaned %>% mutate(count_entries = 1) %>% group_by(psid) %>% summarise(count = sum(count_entries)) %>% ungroup() #'-dU7pmQpdJZMwexZkEFPCA**, this psid answered the survey twice based on occupation answers

survey_cleaned <- survey_cleaned %>% filter(psid != "'-dU7pmQpdJZMwexZkEFPCA**")

write_csv(survey_cleaned, "cleaned_Wave1.csv")

gc()

```

## Load clean Wave1 data

```{r}
survey_cleaned <- read_csv("cleaned_Wave1.csv")

```

# Analysis across demographic

## Set colors

```{r}
# Race/Ethnicity
colors <- c(ghibli_palettes$PonyoMedium,ghibli_palettes$LaputaMedium[3:5])
named_colors_race <- survey_wave1%>%
  mutate(self_race = case_when(
   self_hispanic_latino == "Yes" & grepl(",", self_race) == F ~ "Hispanic/Latino",
   grepl(",", self_race) == T ~ "Multiracial",
   is.na(self_race) ~ "Unknown",
   .default = self_race
  )) %>%
  select(self_race) %>% distinct() %>%
  mutate(colors = colors)

# Gender
colors <- c(rev(ghibli_palettes$SpiritedMedium))
named_colors_gender <- survey_wave1%>%
  mutate(gender = case_when(
    is.na(gender) ~ "Unknown",
    .default = gender
  )) %>%
  select(gender) %>% distinct() %>%
  mutate(colors = colors)
rm(colors)

# Political Affiliation
colors <- c(rev(ghibli_palettes$YesterdayMedium[3:7]))
named_colors_political_affiliation <- survey_wave1%>%
  mutate(self_political_affiliation = case_when(
    is.na(self_political_affiliation) ~ "Unknown",
    .default = self_political_affiliation
  )) %>%
  select(self_political_affiliation) %>% distinct() %>%
  mutate(colors = colors)
rm(colors)

# TODO: Fix the income color
# Income
income_order <- c("$0-$9,999","$10,000 - $24,999", "$25,000-$49,000", "$50,000 - $74,999","$75,000-$99,999","$100,000- $149,000","$150,000 or more", "Unkown")
colors <- colorRampPalette(c("lightblue", "darkblue"))(length(income_order) - 1)
colors <- c(colors, "grey")
named_colors_income <- survey_wave1%>%
  mutate(self_income = case_when(
    is.na(self_income) ~ "Unknown",
    .default = self_income
  )) %>%
  select(self_income) %>% distinct() %>%
   mutate(
     self_income = factor(self_income, levels = income_order),
    colors = ifelse(
      self_income == "Unknown",
      "grey",  
      colors[match(as.character(self_income), income_order)]
    ))%>%
    arrange(match(self_income, income_order))

# Education
education_order <- c("Less than a high school degree", "High school graduate (high school diploma or equivalent including GED)", "Some college but no degree",  "Associate degree in college (2-year)", "Bachelor's degree in college (4-year)", "Master's degree", "Professional degree (JD, MD)", "Doctoral degree", "Unknown")
colors <- colorRampPalette(c("darkred", "pink"))(length(education_order) - 1)
colors <- c(colors, "grey")
named_colors_education <- survey_wave1%>%
  mutate(self_education = case_when(
    is.na(self_education) ~ "Unknown",
    .default = self_education
  )) %>%
  select(self_education) %>% distinct() %>%
   mutate(
     self_education = factor(self_education, levels = education_order),
    colors = ifelse(
      self_education == "Unknown",
      "grey",  
      colors[match(as.character(self_education), education_order)]
    ))%>%
    arrange(match(self_education, education_order))

# Year of Birth
respondent_age_order <- c("18-25","25-35", "35-65", "65+", "Unknown")
colors <- colorRampPalette(c("darkgreen", "lightgreen"))(length(respondent_age_order) - 1)
colors <- c(colors, "grey")
named_colors_respondent_age <- survey_wave1%>%
  mutate(respondent_age = case_when(
    YofB > 1937 & YofB <= 1959 ~ "65+",
    YofB > 1959 & YofB <= 1989 ~ "35-65",
    YofB > 1989 & YofB <= 1999 ~ "25-35",
    YofB > 1999 & YofB <= 2006 ~ "18-25",
    is.na(respondent_age) ~ "Unknown"
  )) %>%
  select(respondent_age) %>% distinct() %>%
   mutate(
     respondent_age = factor(respondent_age, levels = respondent_age_order),
    colors = ifelse(
      respondent_age == "Unknown",
      "grey",  
      colors[match(as.character(respondent_age), respondent_age_order)]
    ))%>%
    arrange(match(respondent_age, respondent_age_order))

# Employment
colors <- c(ghibli_palettes$KikiMedium,ghibli_palettes$LaputaMedium[6:7])
colors <- c(colors, "grey")
named_colors_employment <- survey_wave1%>%
  mutate(self_employment = case_when(
     is.na(self_employment) ~ "Unknown",
    .default = self_employment
  )) %>%
  select(self_employment) %>% distinct() %>%
  mutate(colors = colors)

# Political Ideology
colors <- c(ghibli_palettes$KikiMedium[2:5])
colors <- c(colors, "grey")
named_colors_political_candidate_2020 <- survey_wave1%>%
  mutate(self_political_candidate_2020 = case_when(
     is.na(self_political_candidate_2020) ~ "Unknown",
    .default = self_political_candidate_2020
  )) %>%
  select(self_political_candidate_2020) %>% distinct() %>%
  mutate(colors = colors)

rm(colors)
```

```{r}
length(unique(survey_cleaned$self_political_candidate_2020))
```

## Plot function

```{r}

## qstn: question of interested (e.g. covid testing)
## plot_title: associated title (e.g. "Reasons for COVID-19 testing")
## age_grp: age category that we want to analyze ("Adults", "6-18")
## sample_threshold: minimum number of respondents we need to count a certain demographic group in the analysis - this has to with significance levels, sample size (e.g. "5")
## df: this is the data we are analyzing which should always be survey_cleaned
## demographic: demographic variabel we are interested in (eg. self_race/self_income)

## Here, we want to just run the plot for "income" demographic variable. We want the color to be a gradient as income increases



plot_survey_data <- function(qstn, plot_title, age_grp, demographic, sample_threshold, df){
  
  #set colorplates
  named_colors <- switch(
    demographic,
    "gender" = named_colors_gender,
    "self_race" = named_colors_race,
    "self_political_affiliation" = named_colors_political_affiliation,
    "self_income" = named_colors_income,
    "self_education" = named_colors_education,
    "respondent_age" = named_colors_respondent_age,
    "self_employment" = named_colors_employment,
    "self_political_ideology" = named_colors_political_ideology,
    "self_political_candidate_2020" = named_colors_political_candidate_2020
  )
  
  #get proper dataset and plot
  if (age_grp == "Adult"){
    df2 <- df %>%
      filter(question == qstn) %>%
      mutate(age_cat = "Adults") %>%
      group_by(!!sym(demographic)) %>%
      mutate(total_respondents = n_unique(psid)) %>%
      ungroup() %>%
      left_join(named_colors, by = demographic) %>%
      filter(total_respondents >= sample_threshold, !!sym(demographic) != "Unknown") %>%
      mutate(!!sym(demographic) := factor(!!sym(demographic),levels = named_colors[[demographic]]))
    
    if(nrow(df2) > 0){
    plot_out <- df2 %>%
      ggplot(aes(x = age_cat, y = response_counter, fill = !!sym(demographic))) + 
      stat_summary(aes(), fun.data = mean_cl_normal, geom = "bar", position = "dodge") +
      stat_summary(aes(), fun.data = mean_cl_normal, geom = "errorbar", position = "dodge") +
      stat_compare_means() +
      scale_fill_manual(name = paste("Self-reported", demographic), values = named_colors$colors) + 
      scale_y_continuous("Response rate",labels = scales::percent, expand = expansion(mult = c(0.05, 0.2))) + xlab("Response") +
      theme_minimal() +
      ggtitle(plot_title, age_grp) +
      facet_wrap(~response, strip.position = c("bottom"), labeller = label_wrap_gen()) +
      theme(axis.text = element_text(size = 11, color = "black"),
           axis.title = element_text(size = 12, color = "black"),
           axis.line = element_blank(),
           axis.ticks = element_line(color = "black"),
           axis.ticks.x = element_blank(),
           axis.text.x = element_blank(),
           plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
           plot.title.position = "plot",
           plot.subtitle = element_text(colour = "black", size = 12.5),
           plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
           legend.position = "right",
           legend.margin=margin(1,1.5,0.5,0.5,unit = "line"),
           strip.text = element_text(colour = "black", size = 10.5, hjust = 0),
           strip.background = element_rect(colour="white", fill="white"),
           panel.border = element_rect(colour = "black", fill=NA),
           panel.spacing = unit(0.5, "cm"), aspect.ratio=0.5) 
    plot_out
    
    plot_save_path <- paste("./Survey_Analysis_Figures/figure_demographic/",plot_title,"_", age_grp,"_", demographic,".jpg", sep = "")
  ggsave(plot_save_path, plot_out, width = 12, height = 6)
    }
    
    
} else if (age_grp == "6-18 years") {
  df2 <- df %>%
    filter(!is.na(child_age), child_age == "6-18 years") %>%
    rename(age_cat = child_age) %>%
    filter(question == qstn) %>%
    group_by(!!sym(demographic)) %>%
    mutate(total_respondents = n_unique(psid)) %>%
    ungroup() %>%
    left_join(named_colors, by = demographic) %>%
    filter(total_respondents >= sample_threshold, !!sym(demographic) != "Unknown") %>%
    mutate(!!sym(demographic) := factor(!!sym(demographic),levels = named_colors[[demographic]]))
  
  if (nrow(df2) > 0) {
    plot_out <- df2 %>%
      ggplot(aes(x = age_cat, y = response_counter, fill = !!sym(demographic))) +
      stat_summary(fun.data = mean_cl_normal, geom = "bar", position = "dodge") +
      stat_summary(fun.data = mean_cl_normal, geom = "errorbar", position = "dodge") +
      stat_compare_means() +
      scale_fill_manual(
        name = paste("Self-reported", demographic),
        values = named_colors$colors
      ) +
      scale_y_continuous(
        "Response rate",
        labels = scales::percent,
        expand = expansion(mult = c(0.05, 0.2))
      ) +
      xlab("Response") +
      theme_minimal() +
      ggtitle(plot_title, age_grp) +
      facet_wrap(~response, strip.position = "bottom", labeller = label_wrap_gen()) +
      theme(
        axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        legend.position = "right",
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 12, face = "bold")
      )
    plot_out
    
    plot_save_path <- paste("./Survey_Analysis_Figures/figure_demographic/",plot_title,"_", age_grp,"_", demographic,".jpg", sep = "")
  ggsave(plot_save_path, plot_out, width = 12, height = 6)
}

  
} else if (age_grp == "5 and under"){
      df2 <- df %>%
      filter(!is.na(child_age), child_age == "5 and under") %>%
      rename(age_cat = child_age) %>%
      filter(question == qstn) %>%
      group_by(!!sym(demographic)) %>%
      mutate(total_respondents = n_unique(psid)) %>%
      ungroup() %>%
      left_join(named_colors, by = demographic) %>%
      filter(total_respondents >= sample_threshold, !!sym(demographic) != "Unknown") %>%
      mutate(!!sym(demographic) := factor(!!sym(demographic),levels = named_colors[[demographic]]))
    
  
    if(nrow(df2) > 0){
    plot_out <- df2 %>%
      ggplot(aes(x = age_cat, y = response_counter, fill = !!sym(demographic))) +    
      stat_summary(aes(), fun.data = mean_cl_normal, geom = "bar", position = "dodge") +
      stat_summary(aes(), fun.data = mean_cl_normal, geom = "errorbar", position = "dodge") +
      stat_compare_means() +
      scale_fill_manual(name = paste("Self-reported", demographic), values = named_colors$colors) + 
      scale_y_continuous("Response rate",labels = scales::percent, expand = expansion(mult = c(0.05, 0.2))) + xlab("Response") +
      theme_minimal() +
      ggtitle(plot_title, age_grp) +
      facet_wrap(~response, strip.position = c("bottom"), labeller = label_wrap_gen()) +
      theme(axis.text = element_text(size = 11, color = "black"),
           axis.title = element_text(size = 12, color = "black"),
           axis.line = element_blank(),
           axis.ticks = element_line(color = "black"),
           axis.ticks.x = element_blank(),
           axis.text.x = element_blank(),
           plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
           plot.title.position = "plot",
           plot.subtitle = element_text(colour = "black", size = 12.5),
           plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
           legend.position = "right",
           legend.margin=margin(1,1.5,0.5,0.5,unit = "line"),
           strip.text = element_text(colour = "black", size = 10.5, hjust = 0),
           strip.background = element_rect(colour="white", fill="white"),
           panel.border = element_rect(colour = "black", fill=NA),
           panel.spacing = unit(0.5, "cm"), aspect.ratio=0.5) 
    plot_out
    
    plot_save_path <- paste("./Survey_Analysis_Figures/figure_demographic/",plot_title,"_", age_grp,"_", demographic,".jpg", sep = "")
  ggsave(plot_save_path, plot_out, width = 12, height = 6)
    }
  }
}
```

## Plot function - For proportion(new)

```{r}

plot_survey_data_proportion_new <- function(qstn, plot_title, age_grp, demographic, sample_threshold, df){
  #set colorplates
  named_colors <- switch(
    demographic,
    "gender" = named_colors_gender,
    "self_race" = named_colors_race,
    "self_political_affiliation" = named_colors_political_affiliation,
    "self_income" = named_colors_income,
    "self_education" = named_colors_education,
    "respondent_age" = named_colors_respondent_age,
    "self_employment" = named_colors_employment,
    "self_political_ideology" = named_colors_political_ideology,
    "self_political_candidate_2020" = named_colors_political_candidate_2020
  )
  
  #get proper dataset and plot
  if (age_grp == "Adult"){
    df2 <- df %>%
      filter(question == qstn) %>%
      mutate(age_cat = "Adults") %>%
      group_by(!!sym(demographic)) %>%
      mutate(total_respondents = n_unique(psid)) %>%
      ungroup() %>%
      left_join(named_colors, by = demographic) %>%
      filter(total_respondents >= sample_threshold, !!sym(demographic) != "Unknown") %>%
      mutate(!!sym(demographic) := factor(!!sym(demographic),levels = named_colors[[demographic]]))
    
    chi_results <- df2 %>%
      group_by(response) %>%
           summarise(
    contingency_table = list(table(!!sym(demographic), response_counter)),
    non_zero_rows = sum(rowSums(contingency_table[[1]]) > 0),
    test_type = ifelse(non_zero_rows >= 2 & any(contingency_table[[1]] < 5), 
                       "Fisher's Exact Test", 
                       ifelse(non_zero_rows >= 2, "Chi-Square Test", "Insufficient Data")),
    p_value = ifelse(non_zero_rows >= 2 & nrow(contingency_table[[1]]) > 1 & ncol(contingency_table[[1]]) > 1,
                     ifelse(any(contingency_table[[1]] < 5), 
                            fisher.test(contingency_table[[1]], simulate.p.value = TRUE, B = 10000)$p.value, 
                            chisq.test(contingency_table[[1]])$p.value),
                     NA)) %>%
      mutate(
        label = ifelse(is.na(p_value), 
                       paste(test_type, ": Insufficient Data"), 
                       paste(test_type, ", p =", signif(p_value, 3)))
      )
  #   for (i in 1:nrow(chi_results)) {
  # cat(paste0(
  #   "Response: ", chi_results$response[i], 
  #   " | Test Type: ", chi_results$test_type[i], 
  #   " | P-Value: ", chi_results$p_value[i], "\n"
  # ))
  #   }
    
    if(nrow(df2) > 0){
    plot_out <- df2 %>%
      ggplot(aes(x = age_cat, y = response_counter, fill = !!sym(demographic))) + 
      stat_summary(aes(), fun.data = mean_cl_normal, geom = "bar", position = "dodge") +
      stat_summary(aes(), fun.data = mean_cl_normal, geom = "errorbar", position = "dodge") +
      geom_text(data = chi_results, aes(x = 1, y = 1.1, label = label), inherit.aes = FALSE, size = 2.5) +
      scale_fill_manual(name = paste("Self-reported", demographic), values = named_colors$colors) + 
      scale_y_continuous("Response rate",labels = scales::percent, expand = expansion(mult = c(0.05, 0.2))) + xlab("Response") +
      theme_minimal() +
      ggtitle(plot_title, age_grp) +
      facet_wrap(~response, strip.position = c("bottom"), labeller = label_wrap_gen()) +
      theme(axis.text = element_text(size = 11, color = "black"),
           axis.title = element_text(size = 12, color = "black"),
           axis.line = element_blank(),
           axis.ticks = element_line(color = "black"),
           axis.ticks.x = element_blank(),
           axis.text.x = element_blank(),
           plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
           plot.title.position = "plot",
           plot.subtitle = element_text(colour = "black", size = 12.5),
           plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
           legend.position = "right",
           legend.margin=margin(1,1.5,0.5,0.5,unit = "line"),
           strip.text = element_text(colour = "black", size = 10.5, hjust = 0),
           strip.background = element_rect(colour="white", fill="white"),
           panel.border = element_rect(colour = "black", fill=NA),
           panel.spacing = unit(0.5, "cm"), aspect.ratio=0.5) 
    plot_out
    
    plot_save_path <- paste("./Survey_Analysis_Figures",plot_title,"_", age_grp,"_", demographic,".jpg", sep = "")
  ggsave(plot_save_path, plot_out, width = 12, height = 6)
    }
    
    
} else if (age_grp == "6-18 years") {
  df2 <- df %>%
    filter(!is.na(child_age), child_age == "6-18 years") %>%
    rename(age_cat = child_age) %>%
    filter(question == qstn) %>%
    group_by(!!sym(demographic)) %>%
    mutate(total_respondents = n_unique(psid)) %>%
    ungroup() %>%
    left_join(named_colors, by = demographic) %>%
    filter(total_respondents >= sample_threshold, !!sym(demographic) != "Unknown") %>%
    mutate(!!sym(demographic) := factor(!!sym(demographic),levels = named_colors[[demographic]]))
  
  chi_results <- df2 %>%
      group_by(response) %>%
      summarise(
    contingency_table = list(table(!!sym(demographic), response_counter)),
    non_zero_rows = sum(rowSums(contingency_table[[1]]) > 0),
    test_type = ifelse(non_zero_rows >= 2 & any(contingency_table[[1]] < 5), 
                       "Fisher's Exact Test", 
                       ifelse(non_zero_rows >= 2, "Chi-Square Test", "Insufficient Data")),
    p_value = ifelse(non_zero_rows >= 2 & nrow(contingency_table[[1]]) > 1 & ncol(contingency_table[[1]]) > 1,
                     ifelse(any(contingency_table[[1]] < 5), 
                            fisher.test(contingency_table[[1]], simulate.p.value = TRUE, B = 10000)$p.value, 
                            chisq.test(contingency_table[[1]])$p.value),
                     NA)) %>%
      mutate(
        label = ifelse(is.na(p_value), 
                       paste(test_type, ": Insufficient Data"), 
                       paste(test_type, ", p =", signif(p_value, 3)))
      )
  # for (i in 1:nrow(chi_results)) {
  # cat(paste0(
  #   "Response: ", chi_results$response[i], 
  #   " | Test Type: ", chi_results$test_type[i], 
  #   " | P-Value: ", chi_results$p_value[i], "\n"
  # ))}
  if (nrow(df2) > 0) {
    plot_out <- df2 %>%
      ggplot(aes(x = age_cat, y = response_counter, fill = !!sym(demographic))) +
      stat_summary(fun.data = mean_cl_normal, geom = "bar", position = "dodge") +
      stat_summary(fun.data = mean_cl_normal, geom = "errorbar", position = "dodge") +
      geom_text(data = chi_results, aes(x = 1, y = 1.1, label = label), inherit.aes = FALSE, size = 2.5) +
      scale_fill_manual(
        name = paste("Self-reported", demographic),
        values = named_colors$colors
      ) +
      scale_y_continuous(
        "Response rate",
        labels = scales::percent,
        expand = expansion(mult = c(0.05, 0.2))
      ) +
      xlab("Response") +
      theme_minimal() +
      ggtitle(plot_title, age_grp) +
      facet_wrap(~response, strip.position = "bottom", labeller = label_wrap_gen()) +
      theme(
        axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        legend.position = "right",
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 12, face = "bold")
      )
    plot_out
    
    plot_save_path <- paste("./Survey_Analysis_Figures/figure_demographic_new/",plot_title,"_", age_grp,"_", demographic,".jpg", sep = "")
  ggsave(plot_save_path, plot_out, width = 12, height = 6)
}

  
} else if (age_grp == "5 and under"){
      df2 <- df %>%
      filter(!is.na(child_age), child_age == "5 and under") %>%
      rename(age_cat = child_age) %>%
      filter(question == qstn) %>%
      group_by(!!sym(demographic)) %>%
      mutate(total_respondents = n_unique(psid)) %>%
      ungroup() %>%
      left_join(named_colors, by = demographic) %>%
      filter(total_respondents >= sample_threshold, !!sym(demographic) != "Unknown") %>%
      mutate(!!sym(demographic) := factor(!!sym(demographic),levels = named_colors[[demographic]]))
    
    chi_results <- df2 %>%
      group_by(response) %>%
            summarise(
    contingency_table = list(table(!!sym(demographic), response_counter)),
    non_zero_rows = sum(rowSums(contingency_table[[1]]) > 0),
    test_type = ifelse(non_zero_rows >= 2 & any(contingency_table[[1]] < 5), 
                       "Fisher's Exact Test", 
                       ifelse(non_zero_rows >= 2, "Chi-Square Test", "Insufficient Data")),
    p_value = ifelse(non_zero_rows >= 2 & nrow(contingency_table[[1]]) > 1 & ncol(contingency_table[[1]]) > 1,
                     ifelse(any(contingency_table[[1]] < 5), 
                            fisher.test(contingency_table[[1]], simulate.p.value = TRUE, B = 10000)$p.value, 
                            chisq.test(contingency_table[[1]])$p.value),
                     NA)) %>%
      mutate(
        label = ifelse(is.na(p_value), 
                       paste(test_type, ": Insufficient Data"), 
                       paste(test_type, ", p =", signif(p_value, 2.5)))
      )
  #   for (i in 1:nrow(chi_results)) {
  # cat(paste0(
  #   "Response: ", chi_results$response[i], 
  #   " | Test Type: ", chi_results$test_type[i], 
  #   " | P-Value: ", chi_results$p_value[i], "\n"
  # ))}
    if(nrow(df2) > 0){
    plot_out <- df2 %>%
      ggplot(aes(x = age_cat, y = response_counter, fill = !!sym(demographic))) +    
      stat_summary(aes(), fun.data = mean_cl_normal, geom = "bar", position = "dodge") +
      stat_summary(aes(), fun.data = mean_cl_normal, geom = "errorbar", position = "dodge") +
      geom_text(data = chi_results, aes(x = 1, y = 1.1, label = label), inherit.aes = FALSE, size = 3) +
      scale_fill_manual(name = paste("Self-reported", demographic), values = named_colors$colors) + 
      scale_y_continuous("Response rate",labels = scales::percent, expand = expansion(mult = c(0.05, 0.2))) + xlab("Response") +
      theme_minimal() +
      ggtitle(plot_title, age_grp) +
      facet_wrap(~response, strip.position = c("bottom"), labeller = label_wrap_gen()) +
      theme(axis.text = element_text(size = 11, color = "black"),
           axis.title = element_text(size = 12, color = "black"),
           axis.line = element_blank(),
           axis.ticks = element_line(color = "black"),
           axis.ticks.x = element_blank(),
           axis.text.x = element_blank(),
           plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
           plot.title.position = "plot",
           plot.subtitle = element_text(colour = "black", size = 12.5),
           plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
           legend.position = "right",
           legend.margin=margin(1,1.5,0.5,0.5,unit = "line"),
           strip.text = element_text(colour = "black", size = 10.5, hjust = 0),
           strip.background = element_rect(colour="white", fill="white"),
           panel.border = element_rect(colour = "black", fill=NA),
           panel.spacing = unit(0.5, "cm"), aspect.ratio=0.5) 
    plot_out
    
    plot_save_path <- paste("./Survey_Analysis_Figures/figure_demographic_new/",plot_title,"_", age_grp,"_", demographic,".jpg", sep = "")
  ggsave(plot_save_path, plot_out, width = 12, height = 6)
    }
  }
}
```

## Get Questions

```{r}
get_questions_child <- survey_cleaned %>%
  select(question) %>% distinct() %>%
  filter(substr(question,0,6) == "child_") %>%
  filter(grepl("TEXT",question) == F & grepl("text", question) == F) %>%
  mutate(plot_title = case_when(
    question == "child_why_no_covid_vaccines" ~ "Reasons for declining COVID-19 vaccine",
    question == "child_why_yes_flu_vaccines" ~ "Reasons for accepting influenza vaccine",
    question == "child_why_no_RSV" ~ "Reasons for declining RSV antibody",
    question == "child_why_yes_covid_vaccines" ~ "Reasons for accepting COVID-19 vaccine",
    question == "child_medical_care" ~ "Sought medical care while sick",
    question == "child_why_no_medical_care" ~ "Reasons for not seeking medical care",
    question == "child_why_yes_reduced_contact" ~ "Reasons for reducing contact",
    question == "child_why_no_flu_vaccines" ~ "Reasons for declining influenza vaccine",
    question == "child_why_yes_RSV" ~ "Reasons for accepting RSV antibody",
    question == "child_why_no_reduced_contact" ~ "Reasons for not reducing contact",
    question == "child_health_score" ~ "Rating of child health",
    question == "child_activity_score" ~ "Days out of the month that health interferes with activity",
    question == "child_vaccinated_covid" ~ "Child is vaccinated for COVID-19",
    question == "child_vaccinated_flu" ~ "Child is vaccinated for influenza", 
    question == "child_antibody_RSV" ~ "Child has received RSV antibody",
    question == "child_illness" ~ "Illness in past 12 months",
    question == "child_which_covid_vaccines" ~ "Specific COVID-19 vaccines received",
    question == "child_reduced_contact" ~ "Reduced contact while sick"
  ))


questions_5under <- get_questions_child %>% 
  mutate(age_grp = "5 and under")
questions_618 <- get_questions_child %>% 
  mutate(age_grp = "6-18 years")


get_questions_adult <- survey_cleaned %>%
  select(question) %>% distinct() %>%
  filter(substr(question,0,6) != "child_") %>%
  filter(grepl("TEXT",question) == F & grepl("tex", question) == F) %>%
  filter(grepl("d1_", question) == F & 
           grepl("d2_", question) == F & 
           grepl("d3_", question) == F & 
           grepl("d4_", question) == F & 
           grepl("d5_", question) == F) %>%
  mutate(plot_title = case_when(
    question == "self_why_no_covid_testing" ~ "Reasons for no COVID-19 testing",
    question == "self_why_yes_covid_vaccines" ~ "Reasons for accepting COVID-19 vaccine",
    question == "self_why_no_flu_vaccines" ~ "Reasons for declining influenza vaccine",
    question == "self_why_yes_flu_vaccines" ~ "Reasons for accepting influenza vaccine",
    question == "self_general_medical_care" ~ "Sought medical care (general illness)", 
    question == "self_why_no_general_medical_care" ~ "Reasons for not seeking medical care (general illness)",
    question == "self_why_yes_general_reduced_contact" ~ "Reasons for reducing contact (general illness)",
    question == "self_where_covid_tested" ~ "Locations tested for COVID-19",
    question == "self_why_no_covid_vaccines" ~ "Reasons for declining COVID-19 vaccine",
    question == "self_covid_medical_care" ~ "Sought medical care (COVID-19)",
    question == "self_why_no_covid_medical_care" ~ "Reasons for not seeking medical care (COVID-19)",
    question == "self_why_yes_covid_reduced_contact" ~ "Reasons for reducing contact (COVID-19)",
    question == "self_why_no_general_reduced_contact" ~ "Reasons for not reducing contact (general illness)",
    question == "self_flu_medical_care" ~ "Sought medical care (influenza)",
    question == "self_why_yes_flu_reduced_contact" ~ "Reasons for reducing contact (influenza)",
    question == "self_why_no_covid_reduced_contact" ~ "Reasons for not reducing contact (COVID-19)",
    question == "self_why_no_flu_medical_care" ~ "Reasons for not seeking medical care (influenza)",
    question == "self_why_no_flu_reduced_contact" ~ "Reasons for not reducing contact (influenza)",
    question == "household_size" ~ "Household size",
    question == "children_in_household" ~ "Children in household",
    question == "self_health_score" ~ "Rating of personal health", 
    question == "self_activity_score" ~ "Days out of the month that health interferes with activity",
    question == "self_behavior_changed_COVID" ~ "Changed behavior due to COVID-19",
    question == "self_behavior_changed_flu" ~ "Changed behavior due to influenza",
    question == "self_behavior_changed_RSV" ~ "Changed behavior due to RSV",
    question == "self_covid_tested" ~ "Tested for COVID-19 in past 12 months",
    question == "self_aware_of_SHIELD" ~ "Aware of SHIELD initiative", 
    question == "self_vaccinated_covid" ~ "Vaccinated for COVID-19",
    question == "self_which_covid_vaccines" ~ "Specific COVID-19 vaccines received",
    question == "self_vaccinated_flu" ~ "Vaccinated for influenza", 
    question == "self_illness" ~ "Illness in past 12 months",
    question == "self_concern_COVID" ~ "Level of COVID-19 concern",
    question == "self_concern_flu" ~ "Level of influenza concern",
    question == "self_concern_RSV" ~ "Level of RSV concern",
    question == "self_general_reduced_contact" ~ "Reduced contact (general illness)",
    question == "self_covid_reduced_contact" ~ "Reduced contact (COVID-19)",
    question == "self_flu_reduced_contact" ~ "Reduced contact (influenza)"
  )) %>% mutate(age_grp = "Adult")


#to be expanded
demographic_variable <- data.frame(demographic = c("self_race", "gender", "self_political_affiliation", "self_income", "self_education", "respondent_age", "self_employment", "self_political_ideology", "self_political_candidate_2020"))

get_questions <- rbind(get_questions_adult, questions_5under, questions_618) %>%
   crossing(demographic_variable)
rm(questions_618, questions_5under)
```


Interpretation: Is there an association : answering yes/no for extremely concerned/very concerned/moderately concerned/not concerned vs. race

## Filter demographics variable of interest

```{r}
get_questions_testing <- filter(get_questions, demographic == "self_income")
```

## Testing function and check plots

```{r}
  question <- get_questions_testing$question[61]
  plot_title <- get_questions_testing$plot_title[61]
  age_grp <- get_questions_testing$age_grp[61]

  demographic <- get_questions_testing$demographic[61]
  threshold <- 5
  df <- survey_cleaned
  
  plot_survey_data_proportion_new(qstn = "self_why_no_covid_reduced_contact", plot_title = "Reasons for not reducing contact (COVID-19)", age_grp = "Adult", demographic = "self_income", sample_threshold = threshold, df = df)
```

## Run selected demographic plots

```{r}
for (i in seq(1, nrow(get_questions_testing))){
  
  question <- get_questions_testing$question[i]
  plot_title <- get_questions_testing$plot_title[i]
  age_grp <- get_questions_testing$age_grp[i]

  demographic <- get_questions_testing$demographic[i]
  threshold <- 5
  df <- survey_cleaned
#  print(i)
  plot_survey_data_proportion_new(qstn = question, plot_title = plot_title, age_grp = age_grp, demographic = "self_income", sample_threshold = threshold, df = df)

}

```