---
title: "Model Calibration"
author: "Alyssa Anastasi"
date: "2026-02-02"
output: html_document
---

```{R, warnings=False}
#### GENERAL ######
library(tidyverse)
library(readxl) ## read excel files
library(broom)
library(dplyr)


## calibration
library(bbmle)
library(mgcv)

source("seir_params.R")
source("calibration_source.R")
```

# Load ICU Data

```{R}
data <- read.csv('ICU_data.csv')

#Clean data 
data$date <- as.Date(data$Hour.of.Week.Ending, format = "%d-%b-%y")
data <- data[order(data$date), ]
data <- data[!duplicated(data), ]
```

# COVID-19 Params
```{R} 
cov_data <- data %>% filter(Condition == "COVID-19") %>% filter(date < as.Date("2025-05-24")) %>% mutate(day = (row_number()-1)*7) %>% rename(observed_hosps = Case.Count)

## Set parameter boundaries

#### Set bounds ####
upper_limit = list(
  mu1 = 0.5, 
  mu2 = 0.5, 
  mu3 = 0.5, 
  mu4 = 0.5, 
  mu5 = 0.5, 
  mu6 = 0.5, 
  sig_dist = 20
)

lower_limit = list(
  mu1 = 0.05, 
  mu2 = 0.05, 
  mu3 = 0.05, 
  mu4 = 0.05, 
  mu5 = 0.05, 
  mu6 = 0.05, 
  sig_dist = 0.05
)

pr <- 0.01
pinf <- 0.001

start = list(
  mu1 = 0.1, 
  mu2 = 0.1, 
  mu3 = 0.1, 
  mu4 = 0.2, 
  mu5 = 0.05, 
  mu6 = 0.1,
  sig_dist = 0.15)


m1_A = mle2(minuslogl = cov_loglik,
              start = start,
              data = data,
              method = "L-BFGS-B",
              #fixed = list(mu = 0.03),
              upper= upper_limit,
              lower = lower_limit,
              control=list(maxit=20000, trace=TRUE, parscale=abs(unlist(start))))
  
full <- summary(m1_A)

dt <- data.table::as.data.table(coef(full), .keep.rownames = "word") %>%
  mutate(param = c("mu1", "mu2", "mu3", "mu4", "mu5", "mu6", "sig_dist")) %>%
  mutate(loglik = -m1_A@min,
         AIC = AICc(m1_A))

```
# RSV Params
```{R} 
rsv_data <- data %>% filter(Condition == "RSV") %>% filter(date < as.Date("2025-05-24")) %>% mutate(day = (row_number()-1)*7) %>% rename(observed_hosps = Case.Count)

## Set parameter boundaries

#### Set bounds ####
upper_limit = list(
  mu1 = 0.5, 
  mu2 = 0.5, 
  mu3 = 0.5, 
  mu4 = 0.5, 
  mu5 = 0.5, 
  mu6 = 0.5, 
  sig_dist = 20
)

lower_limit = list(
  mu1 = 0.05, 
  mu2 = 0.05, 
  mu3 = 0.05, 
  mu4 = 0.05, 
  mu5 = 0.05, 
  mu6 = 0.05, 
  sig_dist = 0.05
)

pr <- 0.01
pinf <- 0.001

start = list(
  mu1 = 0.1, 
  mu2 = 0.1, 
  mu3 = 0.1, 
  mu4 = 0.2, 
  mu5 = 0.05, 
  mu6 = 0.1,
  sig_dist = 0.15)


m1_A = mle2(minuslogl = rsv_loglik,
              start = start,
              data = data,
              method = "L-BFGS-B",
              #fixed = list(mu = 0.03),
              upper= upper_limit,
              lower = lower_limit,
              control=list(maxit=20000, trace=TRUE, parscale=abs(unlist(start))))
  
full <- summary(m1_A)

dt_RSV <- data.table::as.data.table(coef(full), .keep.rownames = "word") %>%
  mutate(param = c("mu1", "mu2", "mu3", "mu4", "mu5", "mu6", "sig_dist")) %>%
  mutate(loglik = -m1_A@min,
         AIC = AICc(m1_A))

```
# Flu Params
```{R} 
flu_data <- data %>% filter(Condition == "Flu") %>% filter(date < as.Date("2025-05-24")) %>% mutate(day = (row_number()-1)*7) %>% rename(observed_hosps = Case.Count)

## Set parameter boundaries

#### Set bounds ####
upper_limit = list(
  mu1 = 0.5, 
  mu2 = 0.5, 
  mu3 = 0.5, 
  mu4 = 0.5, 
  mu5 = 0.5, 
  mu6 = 0.5, 
  sig_dist = 20
)

lower_limit = list(
  mu1 = 0.05, 
  mu2 = 0.05, 
  mu3 = 0.05, 
  mu4 = 0.05, 
  mu5 = 0.05, 
  mu6 = 0.05, 
  sig_dist = 0.05
)

pr <- 0.01
pinf <- 0.001

start = list(
  mu1 = 0.1, 
  mu2 = 0.1, 
  mu3 = 0.1, 
  mu4 = 0.2, 
  mu5 = 0.05, 
  mu6 = 0.1,
  sig_dist = 0.15)


m1_A = mle2(minuslogl = flu_loglik,
              start = start,
              data = data,
              method = "L-BFGS-B",
              #fixed = list(mu = 0.03),
              upper= upper_limit,
              lower = lower_limit,
              control=list(maxit=20000, trace=TRUE, parscale=abs(unlist(start))))
  
full <- summary(m1_A)

dt_flu <- data.table::as.data.table(coef(full), .keep.rownames = "word") %>%
  mutate(param = c("mu1", "mu2", "mu3", "mu4", "mu5", "mu6", "sig_dist")) %>%
  mutate(loglik = -m1_A@min,
         AIC = AICc(m1_A))
```